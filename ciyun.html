<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>学生关键词实时词云演示</title>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.1.1/src/wordcloud2.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, #121826 0%, #0b1220 35%, #070b16 100%);
      --panel: rgba(255,255,255,0.06);
      --panel-border: rgba(255,255,255,0.12);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #7dd3fc;
      --accent-2: #a78bfa;
      --accent-3: #f472b6;
      --accent-4: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      background: var(--bg);
      font-family: "Segoe UI", "Noto Sans SC", "Microsoft Yahei", sans-serif;
      padding: 18px;
    }
    .shell {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 18px 20px;
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      backdrop-filter: blur(6px);
      box-shadow: 0 14px 40px rgba(0,0,0,0.28);
    }
    h2 { margin: 0; font-size: 24px; letter-spacing: 0.5px; }
    .hint { color: var(--muted); font-size: 14px; }
    #controls {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      color: var(--text);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 12px 28px rgba(0,0,0,0.28); }
    #transcript {
      margin-top: 16px;
      min-height: 120px;
      border: 1px solid var(--panel-border);
      background: rgba(255,255,255,0.06);
      padding: 14px;
      border-radius: 12px;
      white-space: pre-wrap;
      color: var(--text);
      outline: none;
    }
    #cloudWrap {
      margin-top: 16px;
      width: 100%;
      height: 520px;
      border: 1px solid var(--panel-border);
      background: rgba(125, 211, 252, 0.06);
      border-radius: 18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 18px 48px rgba(0,0,0,0.32);
      position: relative;
      overflow: hidden;
    }
    #keywordsList { margin-top: 10px; color: var(--muted); font-size: 14px; }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      color: var(--muted);
    }
    input[type=range] {
      width: 220px;
    }
    #wordCloudDiv {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .word {
      animation: floatWord 2s ease-in-out infinite;
      animation-delay: calc(var(--delay, 0) * 1s);
      text-shadow: 0 0 8px rgba(255,255,255,0.6), 0 0 16px rgba(255,255,255,0.4);
      transform-origin: center;
    }
    @keyframes floatWord {
      0%, 100% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-8px) scale(1.05); }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h2>学生关键词实时词云演示</h2>
        <div class="hint">用于教室/黑板展示，多人协作输入词句</div>
      </div>
      <div class="hint">词云实时展示：输入词句会实时更新</div>
    </header>

    <div id="controls">
      <input id="textInput" placeholder="输入词句" style="padding: 10px; border-radius: 10px; border: 1px solid var(--panel-border); background: rgba(255,255,255,0.06); color: var(--text); width: 300px;" />
      <button id="sendBtn">发送</button>
      <button id="clearBtn">清空</button>
    </div>

    <div class="slider-row">
      <span>字号倍率</span>
      <input id="sizeSlider" type="range" min="20" max="80" value="46" />
      <span id="sizeValue">46</span>
      <span class="hint">拖动调整词云大小</span>
    </div>

    <div id="cloudWrap"><div id="wordCloudDiv"></div></div>
    <div id="keywordsList"></div>
  </div>

  <script>
    // 视觉加强版：更大字号、稳定刷新（只在最终识别结果时重绘）、无旋转
    const clearBtn = document.getElementById('clearBtn');
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValue = document.getElementById('sizeValue');
    const canvas = document.getElementById('wordCloudDiv');
    const cloudWrap = document.getElementById('cloudWrap');
    const keywordsList = document.getElementById('keywordsList');
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');

    const socket = io();
    socket.on('updateText', (text) => {
      finalTranscript += text + ' ';
      updateKeywords();
    });

    let finalTranscript = '';
    let lastSignature = '';
    let weightBase = Number(sizeSlider.value);

    const palette = ['#7dd3fc', '#a78bfa', '#f472b6', '#fbbf24', '#34d399', '#60a5fa'];
    const stopwords = new Set(["的","了","在","是","我","你","他","她","它","这","那","有","和","就","也","都","而","及","被","其","与","等","不","没","啊","吧","呢","嘛","哦","哦了"]);
    const colorMap = new Map();

    function fitCanvas() {
      // 对于 div 模式，不需要设置 width/height 属性，样式由 CSS 控制
    }

    function sanitizeText(s) {
      return s.replace(/[0-9A-Za-z]/g, ' ').replace(/[\p{P}\p{S}]+/gu, ' ').replace(/\s+/g,' ').trim();
    }

    function extractKeywords(text) {
      text = sanitizeText(text);
      if (!text) return [];
      const phrases = text.split(/\s+/);
      const counts = new Map();
      phrases.forEach(phrase => {
        if (phrase.length > 0 && !stopwords.has(phrase)) {
          counts.set(phrase, (counts.get(phrase) || 0) + 1);
        }
      });
      return Array.from(counts.entries()).sort((a,b) => b[1] - a[1]);
    }

    function renderWordCloud(pairs) {
      // 为展示用的固定颜色映射，保证同一批次的词颜色各异且稳定
      colorMap.clear();
      pairs.forEach(([w], idx) => {
        colorMap.set(w, palette[idx % palette.length]);
      });
      const list = pairs.map(([w,f]) => [w, f]);
      keywordsList.innerText = pairs.length
        ? '关键词： ' + pairs.map(p => `${p[0]}(${p[1]})`).join('、')
        : '暂无关键词';

      // 清空div
      canvas.innerHTML = '';

      WordCloud(canvas, {
        list,
        classes: 'word',
        gridSize: Math.max(8, Math.round(16 * (canvas.clientWidth / 1000))),
        weightFactor: size => {
          // 手机端适配：根据屏幕宽度动态调整字号
          const screenScale = Math.min(1, canvas.clientWidth / 600); 
          const currentBase = weightBase * (0.6 + 0.4 * screenScale);
          return Math.max(currentBase, size * (currentBase / 2));
        },
        fontFamily: '"DIN Alternate", "Segoe UI", "Noto Sans SC", sans-serif',
        color: (word) => colorMap.get(word) || palette[0],
        rotateRatio: 0,
        drawOutOfBound: false,
        shuffle: false
      });

      // 给每个词加随机动画delay
      const words = canvas.querySelectorAll('.word');
      words.forEach(word => {
        word.style.animationDelay = Math.random() * 3 + 's';
      });
    }

    function updateKeywords(text = finalTranscript, force = false) {
      const pairs = extractKeywords(text);
      const signature = JSON.stringify(pairs);
      if (!force && signature === lastSignature) return;
      lastSignature = signature;
      renderWordCloud(pairs);
    }

    clearBtn.addEventListener('click', () => {
      finalTranscript = '';
      lastSignature = '';
      canvas.innerHTML = '';
      keywordsList.innerText = '已清空';
    });

    sendBtn.addEventListener('click', () => {
      const text = textInput.value.trim();
      if (text) {
        socket.emit('addText', text);
        textInput.value = '';
      }
    });

    window.addEventListener('resize', () => {
      fitCanvas();
      updateKeywords(true);
    });

    sizeSlider.addEventListener('input', () => {
      weightBase = Number(sizeSlider.value);
      sizeValue.innerText = weightBase;
      // 立即重绘词云
      const pairs = extractKeywords(finalTranscript);
      renderWordCloud(pairs);
    });

    fitCanvas();
    renderWordCloud([]);
  </script>
</body>
</html>